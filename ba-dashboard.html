<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BA Dashboard - Vaidik Vastu</title>
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link href="assets/css/font.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css"/>
    <link rel="shortcut icon" href="assets/images/vastu_logo.png" type="image/x-icon">
    <script src="toaster.js"></script>
    <style>
        body {
            background: #f5f5f5;
        }
        .navbar {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            padding: 15px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 {
            margin: 0;
            font-size: 24px;
        }
        .logout-btn {
            background: white;
            color: #27ae60;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .container-main {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #27ae60;
            font-size: 32px;
            margin: 10px 0;
        }
        .stat-card p {
            color: #666;
            margin: 0;
        }
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th {
            background: #f0f0f0;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
        }
        table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 5px;
        }
        .btn-primary {
            background: #27ae60;
            color: white;
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending {
            background: #f39c12;
            color: white;
        }
        .status-confirmed {
            background: #27ae60;
            color: white;
        }
        .status-completed {
            background: #3498db;
            color: white;
        }
        .status-cancelled {
            background: #e74c3c;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>üíº BA Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container-main">
        <!-- Stats -->
        <div class="dashboard-grid" id="statsGrid">
            <div class="stat-card">
                <p>Total Earnings</p>
                <h3 id="totalEarnings">-</h3>
            </div>
            <div class="stat-card">
                <p>Approved Earnings</p>
                <h3 id="approvedEarnings">-</h3>
            </div>
            <div class="stat-card">
                <p>Total Referrals</p>
                <h3 id="totalReferrals">-</h3>
            </div>
            <div class="stat-card">
                <p>KYC Status</p>
                <h3 id="kycStatus">-</h3>
            </div>
        </div>

        <!-- Commission Info Section -->
        <div class="section">
            <h2>üí∞ Commission Structure</h2>
            <div style="background: #f0f8f5; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60;">
                <p id="commissionInfo" style="margin: 0; color: #333; font-size: 15px; font-weight: 500;">Loading commission details...</p>
            </div>
        </div>

        <!-- Referral Link Section -->
        <div class="section">
            <h2>üîó Your Referral Link</h2>
            <div style="background: #f0f8f5; padding: 20px; border-radius: 8px; border-left: 4px solid #27ae60;">
                <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">Share this link with potential Business Associates to earn commission per successful referral!</p>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="referralLink" readonly style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: white; font-family: monospace; font-size: 13px;">
                    <button class="btn btn-primary" onclick="copyReferralLink()" style="white-space: nowrap;">üìã Copy Link</button>
                </div>
                <p style="margin: 10px 0 0 0; color: #27ae60; font-size: 13px; font-weight: 600;">Referral Code: <span id="referralCode" style="font-family: monospace;">-</span></p>
            </div>
        </div>

        <!-- Referred BAs Section -->
        <div class="section">
            <h2>üë• BAs Referred by You</h2>
            <div id="referredBAsTable" class="loading">Loading...</div>
        </div>

        <!-- My Bookings Section -->
        <div class="section">
            <h2>My Referral Bookings</h2>
            <div id="bookingsTable" class="loading">Loading...</div>
        </div>

        <!-- Withdrawal History Section -->
        <div class="section">
            <h2>Withdrawal History</h2>
            <div id="withdrawalsTable" class="loading">Loading...</div>
            <button class="btn btn-primary" onclick="requestWithdrawal()" style="margin-top: 15px;">Request Withdrawal</button>
        </div>

        <!-- Assigned Coupons Section -->
        <div class="section">
            <h2>My Assigned Coupons</h2>
            <div id="couponsTable" class="loading">Loading...</div>
        </div>
    </div>

    <script src="assets/js/config.js"></script>
    <script>
        // Wait for config to load, then get API base URL
        let API_BASE_URL = null;

        // Function to initialize API URL
        function initializeAPI() {
            if (typeof APP_CONFIG !== 'undefined' && APP_CONFIG.API_BASE_URL) {
                API_BASE_URL = APP_CONFIG.API_BASE_URL;
                console.log('‚úÖ API_BASE_URL initialized:', API_BASE_URL);
                // Now load dashboard data
                loadDashboardData();
            } else {
                console.error('‚ùå APP_CONFIG not loaded yet');
                setTimeout(initializeAPI, 100);
            }
        }

        // Initialize on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAPI);
        } else {
            initializeAPI();
        }

        const authToken = localStorage.getItem(APP_CONFIG.STORAGE_KEYS.AUTH_TOKEN);
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        // Check authentication
        if (!authToken || user.role !== 'BA') {
            window.location.href = '/login.html';
        }

        // Logout function
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Fetch BA profile and stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/ba/profile`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                const profile = data.data;
                
                document.getElementById('totalEarnings').textContent = `‚Çπ${profile.totalEarnings || 0}`;
                document.getElementById('approvedEarnings').textContent = `‚Çπ${profile.approvedEarnings || 0}`;
                document.getElementById('kycStatus').textContent = profile.kycStatus || 'PENDING';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Fetch commission info
        async function loadCommissionInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/commission/info`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                const data = result.data;

                let commissionText = '';
                if (data.commissionType === 'PERCENTAGE') {
                    commissionText = `You earn <strong>${data.commissionValue}%</strong> of the booking value for each successful referral.`;
                } else {
                    commissionText = `You earn <strong>‚Çπ${data.commissionValue.toLocaleString('en-IN')}</strong> for each successful referral.`;
                }

                const gstInfo = data.excludeGSTFromBase
                    ? `GST (${data.gstPercentage}%) is calculated on top of your commission.`
                    : `GST (${data.gstPercentage}%) is included in your commission.`;

                document.getElementById('commissionInfo').innerHTML =
                    `${commissionText}<br><small style="color: #666; margin-top: 8px; display: block;">${gstInfo}</small>`;
            } catch (error) {
                console.error('Error loading commission info:', error);
                document.getElementById('commissionInfo').textContent = 'Unable to load commission details';
            }
        }

        // Fetch referral info
        async function loadReferralInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/ba/referral-info`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                const data = result.data;

                // Set referral link and code
                document.getElementById('referralLink').value = data.referralLink;
                document.getElementById('referralCode').textContent = data.referralCode;
                document.getElementById('totalReferrals').textContent = data.totalReferrals || 0;

                // Load referred BAs
                loadReferredBAs(data.referredBAs);
            } catch (error) {
                console.error('Error loading referral info:', error);
                document.getElementById('referralLink').value = 'Error loading referral link';
            }
        }

        // Load referred BAs table
        function loadReferredBAs(referredBAs) {
            if (!referredBAs || referredBAs.length === 0) {
                document.getElementById('referredBAsTable').innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No BAs referred yet. Share your referral link to start earning!</p>';
                return;
            }

            let html = '<table><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Joined Date</th></tr></thead><tbody>';
            referredBAs.forEach(ba => {
                const statusClass = `status-${ba.kycStatus.toLowerCase()}`;
                const joinDate = new Date(ba.createdAt).toLocaleDateString();
                html += `<tr>
                    <td>${ba.name}</td>
                    <td>${ba.email}</td>
                    <td><span class="status-badge ${statusClass}">${ba.kycStatus}</span></td>
                    <td>${joinDate}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('referredBAsTable').innerHTML = html;
        }

        // Copy referral link to clipboard
        function copyReferralLink() {
            const referralLink = document.getElementById('referralLink').value;
            navigator.clipboard.writeText(referralLink).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                alert('Failed to copy link');
            });
        }

        // Fetch referral stats
        async function loadReferralStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/ba/referral-stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                // Stats are now loaded from loadReferralInfo
            } catch (error) {
                console.error('Error loading referral stats:', error);
            }
        }

        // Fetch BA bookings
        async function loadBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/ba/bookings`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.data.length === 0) {
                    document.getElementById('bookingsTable').innerHTML = '<p>No bookings yet</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Client</th><th>Service</th><th>Date</th><th>Status</th></tr></thead><tbody>';
                data.data.forEach(booking => {
                    const statusClass = `status-${booking.status.toLowerCase()}`;
                    html += `<tr>
                        <td>${booking.clientName}</td>
                        <td>${booking.serviceType}</td>
                        <td>${new Date(booking.bookingDate).toLocaleDateString()}</td>
                        <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('bookingsTable').innerHTML = html;
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsTable').innerHTML = '<p>Error loading data</p>';
            }
        }

        // Fetch withdrawal history
        async function loadWithdrawals() {
            try {
                const response = await fetch(`${API_BASE_URL}/ba/withdrawal-history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.data.length === 0) {
                    document.getElementById('withdrawalsTable').innerHTML = '<p>No withdrawal history</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Amount</th><th>Date</th><th>Status</th></tr></thead><tbody>';
                data.data.forEach(withdrawal => {
                    const statusClass = `status-${withdrawal.status.toLowerCase()}`;
                    html += `<tr>
                        <td>‚Çπ${withdrawal.amount}</td>
                        <td>${new Date(withdrawal.createdAt).toLocaleDateString()}</td>
                        <td><span class="status-badge ${statusClass}">${withdrawal.status}</span></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('withdrawalsTable').innerHTML = html;
            } catch (error) {
                console.error('Error loading withdrawals:', error);
                document.getElementById('withdrawalsTable').innerHTML = '<p>Error loading data</p>';
            }
        }

        // Fetch assigned coupons
        async function loadCoupons() {
            try {
                const response = await fetch(`${API_BASE_URL}/ba/assigned-coupons`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.data.length === 0) {
                    document.getElementById('couponsTable').innerHTML = '<p>No coupons assigned</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Code</th><th>Discount</th><th>Expiry</th></tr></thead><tbody>';
                data.data.forEach(coupon => {
                    html += `<tr>
                        <td><strong>${coupon.code}</strong></td>
                        <td>${coupon.discountPercentage}%</td>
                        <td>${new Date(coupon.expiryDate).toLocaleDateString()}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('couponsTable').innerHTML = html;
            } catch (error) {
                console.error('Error loading coupons:', error);
                document.getElementById('couponsTable').innerHTML = '<p>Error loading data</p>';
            }
        }

        // Request withdrawal
        async function requestWithdrawal() {
            const amount = prompt('Enter withdrawal amount (‚Çπ):');
            if (!amount || isNaN(amount)) {
                toaster.warning('Please enter a valid amount');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/ba/request-withdrawal`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ amount: parseFloat(amount) })
                });

                const data = await response.json();

                if (response.ok) {
                    toaster.success('Withdrawal request submitted successfully');
                    loadWithdrawals();
                } else {
                    toaster.error(data.error || 'Error submitting withdrawal request');
                }
            } catch (error) {
                toaster.error('Network error: ' + error.message);
            }
        }

        // Load all dashboard data
        function loadDashboardData() {
            console.log('üìä Loading BA dashboard data...');
            loadStats();
            loadCommissionInfo();
            loadReferralInfo();
            loadBookings();
            loadWithdrawals();
            loadCoupons();

            // Refresh every 30 seconds
            setInterval(() => {
                loadStats();
                loadCommissionInfo();
                loadReferralInfo();
                loadBookings();
                loadWithdrawals();
                loadCoupons();
            }, 30000);
        }
    </script>
</body>
</html>

